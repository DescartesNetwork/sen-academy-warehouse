{
  "createdAt": 1653977759865,
  "updatedAt": 1653979752661,
  "thumbnail": "https://i.imgur.com/ynEC4lA.jpg",
  "category": [
    "solana",
    "web3camp",
    "dev"
  ],
  "en": {
    "contents": "Trong bài này, chúng ta sẽ cùng nhau phân tích một sản phẩm DeFi điển hình: đó là Công cụ tạo lập thị trường tự động **(Automated Market Maker, hay AMM)**, cũng như hệ sinh xung quanh chính nó. Từ đó, bạn đọc sẽ có được một cái nhìn sâu sắc về kỹ thuật cũng như cách phát triển hệ sinh thái cho ý tưởng riêng của mình.\n\n<iframe width=\"100%\" height=\"512\" src=\"https://www.youtube.com/embed/D5B2U56T8iY\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\n# CLOB vs AMM\n\nBạn có thể ít nhiều đã nghe đến các sàn giao dịch như cổ phiếu hoặc crypto, nơi thanh khoản được tạo ra bởi chính người dùng. Thanh khoản ở đây được hiểu đơn giản như sau: Bạn muốn bán A để lấy B, và trên thị trường đang có nhiều người bán B để lấy A đối ứng. Khi giao dịch của bạn được khớp nhanh chóng với người đối ứng, thì đó là một thị trường thanh khoản tốt. Các hình thức tổ chức giao dịch như vậy được gọi là Central Limit Order Book hay **CLOB**. Các lệnh mua bán được tạo ra bởi chính người dùng, và việc mua bán diễn ra khi có 2 lệnh khớp nhau. Vấn đề lớn nhất đối với các sàn dạng CLOB là một số tài sản sẽ có thanh khoản kém và gần như không thể thực hiện giao dịch, hoặc giao dịch mất thời gian rất lâu để khớp lệnh đối ứng. AMM được sinh ra nhằm giải quyết vấn đề này.\n\n**AMM** định nghĩa sẵn một đường cong giá trị, ví dụ như cặp tài sản A/B. Người dùng được khuyến khích đặt (deposit) tiền vào trong một hồ (pool) chung để tạo thanh khoản cho AMM. Khi ấy, người tham gia sẽ trở thành nhà cung cấp thanh khoản. Khi có một giao dịch được đặt lệnh, ngay lập tức AMM sẽ dựa vào đường cong giá để tính toán lượng tài sản bán ra sẽ là bao nhiêu. Đường cong giá này sẽ đảm bảo tuân thủ theo quy luật cung cầu, cũng như tính công bằng cho cả người cung cấp thanh khoản và người giao dịch. Với mỗi giao dịch, nhà cung cấp thanh khoản sẽ nhận được một khoảng phí nhỏ làm phần thưởng cho thanh khoản họ cung cấp vào. Còn về phía nhà giao dịch, tất cả các lệnh sẽ được giao dịch ngay tức khắc. Như vậy, AMM “giả lập” một thị trường với thanh khoản rất cao.\n\n<img style=\"max-width:512px;display:block;margin:auto;\" src=\"https://i.imgur.com/vydkmGJ.png\" alt=\"CLOB_AMM\"/>\n<p style=\"text-align:center;font-style:italic;\">Hình 1. So sánh cơ chế giữa CLOB và AMM.</p>\n\n# Đường cong giá trị (Pricing Curve)\n\nĐể biểu diễn được quy luật cung cầu, đường cong giá trị nổi tiếng và được sử dụng rộng rãi hiện nay chính là hàm tích hằng (Product Constant Function). Hàm tích hằng được thể hiện như sau:\n\n**Hàm tích hằng.** Với một thị trường cho cặp $A$ và $B$ với lượng thanh khoản cho trước là $R_A$ và $R_B$, tất cả các giao dịch phải tuân theo:\n\n<div class=\"math math-display\">R_A \\times R_B = k</div>\n\nGiả sử trạng thái hiện tại của thị trường là $R_A$ và có một giao dịch bán $A$ với lượng $r_A$.\n\nKhi này $R'_A = R_A + r_A$ đồng thời phía $B$ sẽ chuyển sang trạng thái mới là $R'_B$ sao cho:\n\n<div class=\"math math-display\">R_A \\times R_B = R'_A \\times R'_B = k</div>\n\nBằng công thức, chúng ta có thể tính toán được $R'_B$ sau đó tính được lượng $r_B = R_B - R'_B$ trả ra cho người giao dịch.\n\n<img style=\"max-width:512px;display:block;margin:auto;\" src=\"https://i.imgur.com/fY0Sp3I.png\" alt=\"curve\"/>\n<p style=\"text-align:center;font-style:italic;\">Hình 2. Đường cong giá trị <span class=\"math math-inline\">xy=1.</span></p>\n\n**Giá cả.** Gọi giá của thị trường của $A$ và $B$ là $p$, khi đó $p = R_A / R_B$.\n\nVới ví dụ bên trên, khi nhà giao dịch bán $A$ để lấy $B$, điều đó đồng nghĩa với việc lượng $A$ trong hồ sẽ nhiều hơn và lượng $B$ sẽ ít đi. Lúc này giá cả sau giao dịch sẽ tăng, cụ thể hơn là nhà giao dịch cần nhiều $A$ hơn để mua cùng một lượng $B$ với các giao dịch tiếp theo.\n\n# Token thanh khoản (Liquidity Provision Token)\n\nNhư đã nhắc ở trên, với mỗi giao dịch sẽ có một lượng phí nhỏ được thu và chia lại theo tỷ lệ cho các nhà cung cấp thanh khoản. Vấn đề đặt ra là hệ thống cần tổ chức một cơ chế ghi nhận số lượng thanh khoản mỗi cá nhân đã cung cấp. Cơ chế token hoá (tokenization) hiện tại là giải pháp hữu hiệu nhất. Với mỗi cặp token thanh khoản được cung cấp, nhà cung cấp thanh khoản sẽ được nhận lại một số lượng token thanh khoản (hay còn gọi là LP token) để bảo chứng cho số lượng thanh khoản đã được cung cấp vào AMM.\n\n**Token thanh khoản.** Một cá nhân cung cấp thanh khoản với số lượng $R_A$ và $R_B$ cho thị trường, số lượng token thanh khoản nhận lại sẽ là:\n\n<div class=\"math math-display\">LP = \\sqrt{R_A \\times R_B}</div>\n\nLưu ý ở đây rằng khi cung cấp hoặc rút thanh khoản, giá trị $k$ trong hàm tích hằng phải được thay đổi để phù hợp với trạng thái mới của thanh khoản trong thị trường.\n\n**Phái sinh.** $LP$ cũng là token có giá trị, khi giá trị của $LP$ được neo với 2 token $A$ và $B$ trong hồ. Do đó, ta có thể xem $LP$ như một sản phẩm phái sinh có thể trao đổi được trong tương lai, tương tự như hợp đồng nợ, hợp đồng quyền chọn, vân vân.\n\n# Các dạng thức khác của hàm tích hằng\n\n## Hàm tích hằng tổng quát\n\nHàm tích hằng ở trên chỉ có thể áp dụng cho 2 tài sản trong một hồ, và đặt biệt hai tài sản này phải có tổng giá trị quy đổi ngang bằng nhau. Trong thực tế, nhu cầu về cấu trúc hồ phức tạp hơn rất nhiều như thế khi mà số lượng tài sản có thể là 3, 4 hoặc thậm chí 10. Các hồ lệch cũng cần thiết trong một số tình huống (hồ lệch khi giá trị quy đổi của các tài sản trong hồ là không bằng nhau). Vì vậy, hàm tích hằng tổng quát ra đời nhằm đáp ứng các nhu cầu này.\n\n**Hàm tích hằng tổng quát.** Với một thị trường cho nhóm $n$ tài sản $A_{1..n}$ với lượng thanh khoản cho trước là $R_{i..n}$ tất cả các giao dịch phải tuân theo:\n\n<div class=\"math math-display\">\\sum_{i=1}^{n} R_i^{\\omega_i} = k</div>\n\nTrong đó $\\omega_i$ là trọng số điều chỉnh độ lệch của tài sản trong hồ.\n\nSo với hàm tích hằng đơn thuần, hàm tích hằng tổng quát cho phép nhiều tài sản cùng xây dựng một hồ. Hơn thế, giá trị quy đổi của các tài sản trong hồ được điều chỉnh thông qua trọng số. Điều này giúp điều chỉnh hồ lại về thế cân bằng theo lý thuyết tính toán.\n\n**Hàm tích hằng khuếch đại.** Với một thị trường cho cặp tài sản $A$ và $B$ có giá trị quy đổi không biến thiên hoặc biến thiên rất nhỏ so với nhau, với lượng thanh khoản cho trước là $R_A$  và $R_B$, tất cả các giao dịch phải tuân theo:\n\n<div class=\"math math-display\">\\gamma_A R_A \\times \\gamma_B R_B = k</div>\n\nTrong đó $\\gamma_A$, $\\gamma_B$ là hệ số khuếch đại trong hồ.\n\nCặp tài sản không biến thiên hoặc biến thiên rất ít thường là các cặp token ổn định (stable token) ví dụ như USDC-USDT đều có giá trị loanh quoanh \\$1. Nếu ta sử dụng hàm tích hằng đơn thuần, một lượng lớn thanh khoản trải dài trên khoản giá từ \\$1 đến $\\infty$ và sẽ hiếm khi được sử dụng đến, gây ra lãng phí thanh khoản. Bằng các hệ số $\\gamma$, hàm tích hằng khuếch đại sẽ “nén” thanh khoản về vùng giá hiệu quả, là \\$1 cho ví dụ của cặp USDC-USDT. Nhờ đó thanh khoản được sử dụng hiểu quả và giảm thiểu trượt giá hơn.\n\n# Lưu ý khi xây dựng chương trình\n\n## Tràn số\n\nThông thường số lượng token trên Solana được lưu dưới kiểu `u64`. Nghĩa là các phép tính nhân trong công thức tích hằng chỉ an toàn trên kiểu `u128`.\n\n## Làm tròn\n\nLàm tròn quá bán là một lựa chọn đơn giản và phổ biến trong đời sống hằng ngày, nhưng nó lại rất nguy hiểm trong các ứng dụng DeFi. Vì các tính toán trong chương trình trên blockchain đều được ưu tiên tính toán bằng số nguyên, nghĩa là việc làm tròn “không chiến lược” có thể dẫn đến hiện tượng sai lệch và có thể bị tấn công trong một số tình huống nhất định.\n\nHãy cùng quan sát ví dụ sau đây. Trong chương trình hiện đang có 11 token, A và B viết một chương trình chia đôi lượng tài sản này. Theo lẽ dĩ nhiên mỗi người sẽ nhận được 5.5 token. Tuy nhiên vì chương trình thực hiện tính toán dựa trên số nguyên và làm tròn quá bán (hoặc làm tròn lên) nên số token mỗi người sẽ nhận là 6. Tổng cả A và B sẽ là 12 trong khi tài khoản chương trình chỉ có 11. Việc này dẫn đến số tài sản này không thể được rút và khoá vĩnh viễn.\n\nViệc xác định chiến lược làm tròn rất quan trọng, bạn đọc cần dựa trên tính chất chương trình của mình để đưa ra quyết định phù hợp nhất.\n\n## Tấn công Re-Entrancy\n\nĐây là một kiểu tấn công rất phổ biến ở trong lập trình DeFi. Hãy quan sát ví dụ sau, một trương trình thực hiện việc chuyển tiền với các bước như sau:\n\n- Bước 1: Kiểm tra số dư\n- Bước 2: Chuyển tiền\n- Bước 3: Cập nhật số dư mới trong hồ\n\nỞ bước 1, việc chuyển tiền được Solana Program của bạn gọi qua SPL Program tuy nhiên “attacker” lại điều hướng sang một Solana Program khác để tiếp tục gọi lại chương trình của bạn. Lúc này, vì bước 2 chưa thực hiện xong nên số dư vẫn chưa được cập nhật. Vì vậy ở lần gọi thứ 2, kiểm tra số dư vẫn cho ra kết quả hợp lệ và tiếp tục thực hiện việc chuyển tiền.\n\nKiểu tấn công trên thường rất phổ biến trên Ethereum do cơ chế gọi hàm fallback. May thay, ở Solana vẫn chưa ghi nhận vụ tấn công nào sử dụng thủ thuật trên, tuy nhiên không vì thế mà khi viết chương trình chúng ta có thể bỏ qua lỗ hổng này.\n\n## Thiếu kiểm tra account\n\nThông thường một tài khoản (account) được thuê và định danh bởi rất nhiều thông tin. Ví dụ như một hồ được tạo ra có thể chứa nhiều thông tin về loại token trong hồ. Vì cơ chế không-trạng-thái (stateless), các tài khoản này sẽ được truyền lên bởi người dùng trong giao dịch liên quan. “Attacker” có thể lợi dụng để truyền các tài khoản không chính xác để khai thác lỗ hổng nếu chương trình thiếu đi các cơ chế kiểm tra đầy đủ. Các vụ tấn công nổi tiếng dùng cơ chế này diễn ra gần đây như Cashio, Wormhole, vân vân.\n\n# Hơn cả một AMM\n\nNhư đã đề cập ở trên, LP có thể được xem là sản phẩm phái sinh và có giá trị thực. Các LP này có thể được sử dụng như là đầu vào cho các sản phẩm tài chính khác.\n\n## Gửi tiết kiệm (Farming, Staking)\n\nHiện nay có nhiều giao thức cho phép nhà cung cấp thanh khoản khoán LP vào trong một hồ mới nhằm đào hoặc khai thác những token khác. Nhà cung cấp thành khoản có thể sinh ra nhiều lợi nhuận hơn, bên cạnh phí từ các hồ thanh khoản trong AMM.\n\n## Thế chấp\n\nỨng dụng tiếp theo của LP có thể được dùng để thế chấp và vay những token khác. Có 2 cơ chế vay khá phổ biến. Một là vay các token có sẵn ví như ETH, wSOL, vân vân. Hai là vay một token ổn định (stable token) - các token này thường có giá trị $1 và được đúc ra tương ứng với lượng LP khoá vào.\n\n## Quỹ chỉ số\n\nỞ mô hình hàm tích hằng tổng quát, số lượng token có thể nhiều hơn 2. Khi đó LP được xem như một token đại diện cho “rổ” đầu tư. Thay vì mua một token duy nhất, người dùng có thể tham khảo mua một nhóm các token mạnh. Bạn không nhất thiết phải mua từng token một, mà chỉ cần mua LP cho hồ đại diện rổ token bạn muốn.\n\n# Lời kết\n\nQua bài viết, hi vọng bạn đọc đã có một cái nhìn tổng quát về AMM cũng như hệ sinh thái xung quanh một giao thức. Để xây dựng một giao thức thành công, các nhà sáng lập không chỉ cần xây dựng một hệ thống tốt, mà còn phải xây dựng một hệ thống có thể kết nối với các sinh thái xung quanh nó để tối đa hoá tài nguyên, cũng như mở rộng quy mô.",
    "title": "Những ví dụ kinh điển về DeFi"
  },
  "vn": {
    "contents": "Trong bài này, chúng ta sẽ cùng nhau phân tích một sản phẩm DeFi điển hình: đó là Công cụ tạo lập thị trường tự động **(Automated Market Maker, hay AMM)**, cũng như hệ sinh xung quanh chính nó. Từ đó, bạn đọc sẽ có được một cái nhìn sâu sắc về kỹ thuật cũng như cách phát triển hệ sinh thái cho ý tưởng riêng của mình.\n\n<iframe width=\"100%\" height=\"512\" src=\"https://www.youtube.com/embed/D5B2U56T8iY\" title=\"YouTube video player\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\n# CLOB vs AMM\n\nBạn có thể ít nhiều đã nghe đến các sàn giao dịch như cổ phiếu hoặc crypto, nơi thanh khoản được tạo ra bởi chính người dùng. Thanh khoản ở đây được hiểu đơn giản như sau: Bạn muốn bán A để lấy B, và trên thị trường đang có nhiều người bán B để lấy A đối ứng. Khi giao dịch của bạn được khớp nhanh chóng với người đối ứng, thì đó là một thị trường thanh khoản tốt. Các hình thức tổ chức giao dịch như vậy được gọi là Central Limit Order Book hay **CLOB**. Các lệnh mua bán được tạo ra bởi chính người dùng, và việc mua bán diễn ra khi có 2 lệnh khớp nhau. Vấn đề lớn nhất đối với các sàn dạng CLOB là một số tài sản sẽ có thanh khoản kém và gần như không thể thực hiện giao dịch, hoặc giao dịch mất thời gian rất lâu để khớp lệnh đối ứng. AMM được sinh ra nhằm giải quyết vấn đề này.\n\n**AMM** định nghĩa sẵn một đường cong giá trị, ví dụ như cặp tài sản A/B. Người dùng được khuyến khích đặt (deposit) tiền vào trong một hồ (pool) chung để tạo thanh khoản cho AMM. Khi ấy, người tham gia sẽ trở thành nhà cung cấp thanh khoản. Khi có một giao dịch được đặt lệnh, ngay lập tức AMM sẽ dựa vào đường cong giá để tính toán lượng tài sản bán ra sẽ là bao nhiêu. Đường cong giá này sẽ đảm bảo tuân thủ theo quy luật cung cầu, cũng như tính công bằng cho cả người cung cấp thanh khoản và người giao dịch. Với mỗi giao dịch, nhà cung cấp thanh khoản sẽ nhận được một khoảng phí nhỏ làm phần thưởng cho thanh khoản họ cung cấp vào. Còn về phía nhà giao dịch, tất cả các lệnh sẽ được giao dịch ngay tức khắc. Như vậy, AMM “giả lập” một thị trường với thanh khoản rất cao.\n\n<img style=\"max-width:512px;display:block;margin:auto;\" src=\"https://i.imgur.com/vydkmGJ.png\" alt=\"CLOB_AMM\"/>\n<p style=\"text-align:center;font-style:italic;\">Hình 1. So sánh cơ chế giữa CLOB và AMM.</p>\n\n# Đường cong giá trị (Pricing Curve)\n\nĐể biểu diễn được quy luật cung cầu, đường cong giá trị nổi tiếng và được sử dụng rộng rãi hiện nay chính là hàm tích hằng (Product Constant Function). Hàm tích hằng được thể hiện như sau:\n\n**Hàm tích hằng.** Với một thị trường cho cặp $A$ và $B$ với lượng thanh khoản cho trước là $R_A$ và $R_B$, tất cả các giao dịch phải tuân theo:\n\n<div class=\"math math-display\">R_A \\times R_B = k</div>\n\nGiả sử trạng thái hiện tại của thị trường là $R_A$ và có một giao dịch bán $A$ với lượng $r_A$.\n\nKhi này $R'_A = R_A + r_A$ đồng thời phía $B$ sẽ chuyển sang trạng thái mới là $R'_B$ sao cho:\n\n<div class=\"math math-display\">R_A \\times R_B = R'_A \\times R'_B = k</div>\n\nBằng công thức, chúng ta có thể tính toán được $R'_B$ sau đó tính được lượng $r_B = R_B - R'_B$ trả ra cho người giao dịch.\n\n<img style=\"max-width:512px;display:block;margin:auto;\" src=\"https://i.imgur.com/fY0Sp3I.png\" alt=\"curve\"/>\n<p style=\"text-align:center;font-style:italic;\">Hình 2. Đường cong giá trị <span class=\"math math-inline\">xy=1.</span></p>\n\n**Giá cả.** Gọi giá của thị trường của $A$ và $B$ là $p$, khi đó $p = R_A / R_B$.\n\nVới ví dụ bên trên, khi nhà giao dịch bán $A$ để lấy $B$, điều đó đồng nghĩa với việc lượng $A$ trong hồ sẽ nhiều hơn và lượng $B$ sẽ ít đi. Lúc này giá cả sau giao dịch sẽ tăng, cụ thể hơn là nhà giao dịch cần nhiều $A$ hơn để mua cùng một lượng $B$ với các giao dịch tiếp theo.\n\n# Token thanh khoản (Liquidity Provision Token)\n\nNhư đã nhắc ở trên, với mỗi giao dịch sẽ có một lượng phí nhỏ được thu và chia lại theo tỷ lệ cho các nhà cung cấp thanh khoản. Vấn đề đặt ra là hệ thống cần tổ chức một cơ chế ghi nhận số lượng thanh khoản mỗi cá nhân đã cung cấp. Cơ chế token hoá (tokenization) hiện tại là giải pháp hữu hiệu nhất. Với mỗi cặp token thanh khoản được cung cấp, nhà cung cấp thanh khoản sẽ được nhận lại một số lượng token thanh khoản (hay còn gọi là LP token) để bảo chứng cho số lượng thanh khoản đã được cung cấp vào AMM.\n\n**Token thanh khoản.** Một cá nhân cung cấp thanh khoản với số lượng $R_A$ và $R_B$ cho thị trường, số lượng token thanh khoản nhận lại sẽ là:\n\n<div class=\"math math-display\">LP = \\sqrt{R_A \\times R_B}</div>\n\nLưu ý ở đây rằng khi cung cấp hoặc rút thanh khoản, giá trị $k$ trong hàm tích hằng phải được thay đổi để phù hợp với trạng thái mới của thanh khoản trong thị trường.\n\n**Phái sinh.** $LP$ cũng là token có giá trị, khi giá trị của $LP$ được neo với 2 token $A$ và $B$ trong hồ. Do đó, ta có thể xem $LP$ như một sản phẩm phái sinh có thể trao đổi được trong tương lai, tương tự như hợp đồng nợ, hợp đồng quyền chọn, vân vân.\n\n# Các dạng thức khác của hàm tích hằng\n\n## Hàm tích hằng tổng quát\n\nHàm tích hằng ở trên chỉ có thể áp dụng cho 2 tài sản trong một hồ, và đặt biệt hai tài sản này phải có tổng giá trị quy đổi ngang bằng nhau. Trong thực tế, nhu cầu về cấu trúc hồ phức tạp hơn rất nhiều như thế khi mà số lượng tài sản có thể là 3, 4 hoặc thậm chí 10. Các hồ lệch cũng cần thiết trong một số tình huống (hồ lệch khi giá trị quy đổi của các tài sản trong hồ là không bằng nhau). Vì vậy, hàm tích hằng tổng quát ra đời nhằm đáp ứng các nhu cầu này.\n\n**Hàm tích hằng tổng quát.** Với một thị trường cho nhóm $n$ tài sản $A_{1..n}$ với lượng thanh khoản cho trước là $R_{i..n}$ tất cả các giao dịch phải tuân theo:\n\n<div class=\"math math-display\">\\sum_{i=1}^{n} R_i^{\\omega_i} = k</div>\n\nTrong đó $\\omega_i$ là trọng số điều chỉnh độ lệch của tài sản trong hồ.\n\nSo với hàm tích hằng đơn thuần, hàm tích hằng tổng quát cho phép nhiều tài sản cùng xây dựng một hồ. Hơn thế, giá trị quy đổi của các tài sản trong hồ được điều chỉnh thông qua trọng số. Điều này giúp điều chỉnh hồ lại về thế cân bằng theo lý thuyết tính toán.\n\n**Hàm tích hằng khuếch đại.** Với một thị trường cho cặp tài sản $A$ và $B$ có giá trị quy đổi không biến thiên hoặc biến thiên rất nhỏ so với nhau, với lượng thanh khoản cho trước là $R_A$  và $R_B$, tất cả các giao dịch phải tuân theo:\n\n<div class=\"math math-display\">\\gamma_A R_A \\times \\gamma_B R_B = k</div>\n\nTrong đó $\\gamma_A$, $\\gamma_B$ là hệ số khuếch đại trong hồ.\n\nCặp tài sản không biến thiên hoặc biến thiên rất ít thường là các cặp token ổn định (stable token) ví dụ như USDC-USDT đều có giá trị loanh quoanh \\$1. Nếu ta sử dụng hàm tích hằng đơn thuần, một lượng lớn thanh khoản trải dài trên khoản giá từ \\$1 đến $\\infty$ và sẽ hiếm khi được sử dụng đến, gây ra lãng phí thanh khoản. Bằng các hệ số $\\gamma$, hàm tích hằng khuếch đại sẽ “nén” thanh khoản về vùng giá hiệu quả, là \\$1 cho ví dụ của cặp USDC-USDT. Nhờ đó thanh khoản được sử dụng hiểu quả và giảm thiểu trượt giá hơn.\n\n# Lưu ý khi xây dựng chương trình\n\n## Tràn số\n\nThông thường số lượng token trên Solana được lưu dưới kiểu `u64`. Nghĩa là các phép tính nhân trong công thức tích hằng chỉ an toàn trên kiểu `u128`.\n\n## Làm tròn\n\nLàm tròn quá bán là một lựa chọn đơn giản và phổ biến trong đời sống hằng ngày, nhưng nó lại rất nguy hiểm trong các ứng dụng DeFi. Vì các tính toán trong chương trình trên blockchain đều được ưu tiên tính toán bằng số nguyên, nghĩa là việc làm tròn “không chiến lược” có thể dẫn đến hiện tượng sai lệch và có thể bị tấn công trong một số tình huống nhất định.\n\nHãy cùng quan sát ví dụ sau đây. Trong chương trình hiện đang có 11 token, A và B viết một chương trình chia đôi lượng tài sản này. Theo lẽ dĩ nhiên mỗi người sẽ nhận được 5.5 token. Tuy nhiên vì chương trình thực hiện tính toán dựa trên số nguyên và làm tròn quá bán (hoặc làm tròn lên) nên số token mỗi người sẽ nhận là 6. Tổng cả A và B sẽ là 12 trong khi tài khoản chương trình chỉ có 11. Việc này dẫn đến số tài sản này không thể được rút và khoá vĩnh viễn.\n\nViệc xác định chiến lược làm tròn rất quan trọng, bạn đọc cần dựa trên tính chất chương trình của mình để đưa ra quyết định phù hợp nhất.\n\n## Tấn công Re-Entrancy\n\nĐây là một kiểu tấn công rất phổ biến ở trong lập trình DeFi. Hãy quan sát ví dụ sau, một trương trình thực hiện việc chuyển tiền với các bước như sau:\n\n- Bước 1: Kiểm tra số dư\n- Bước 2: Chuyển tiền\n- Bước 3: Cập nhật số dư mới trong hồ\n\nỞ bước 1, việc chuyển tiền được Solana Program của bạn gọi qua SPL Program tuy nhiên “attacker” lại điều hướng sang một Solana Program khác để tiếp tục gọi lại chương trình của bạn. Lúc này, vì bước 2 chưa thực hiện xong nên số dư vẫn chưa được cập nhật. Vì vậy ở lần gọi thứ 2, kiểm tra số dư vẫn cho ra kết quả hợp lệ và tiếp tục thực hiện việc chuyển tiền.\n\nKiểu tấn công trên thường rất phổ biến trên Ethereum do cơ chế gọi hàm fallback. May thay, ở Solana vẫn chưa ghi nhận vụ tấn công nào sử dụng thủ thuật trên, tuy nhiên không vì thế mà khi viết chương trình chúng ta có thể bỏ qua lỗ hổng này.\n\n## Thiếu kiểm tra account\n\nThông thường một tài khoản (account) được thuê và định danh bởi rất nhiều thông tin. Ví dụ như một hồ được tạo ra có thể chứa nhiều thông tin về loại token trong hồ. Vì cơ chế không-trạng-thái (stateless), các tài khoản này sẽ được truyền lên bởi người dùng trong giao dịch liên quan. “Attacker” có thể lợi dụng để truyền các tài khoản không chính xác để khai thác lỗ hổng nếu chương trình thiếu đi các cơ chế kiểm tra đầy đủ. Các vụ tấn công nổi tiếng dùng cơ chế này diễn ra gần đây như Cashio, Wormhole, vân vân.\n\n# Hơn cả một AMM\n\nNhư đã đề cập ở trên, LP có thể được xem là sản phẩm phái sinh và có giá trị thực. Các LP này có thể được sử dụng như là đầu vào cho các sản phẩm tài chính khác.\n\n## Gửi tiết kiệm (Farming, Staking)\n\nHiện nay có nhiều giao thức cho phép nhà cung cấp thanh khoản khoán LP vào trong một hồ mới nhằm đào hoặc khai thác những token khác. Nhà cung cấp thành khoản có thể sinh ra nhiều lợi nhuận hơn, bên cạnh phí từ các hồ thanh khoản trong AMM.\n\n## Thế chấp\n\nỨng dụng tiếp theo của LP có thể được dùng để thế chấp và vay những token khác. Có 2 cơ chế vay khá phổ biến. Một là vay các token có sẵn ví như ETH, wSOL, vân vân. Hai là vay một token ổn định (stable token) - các token này thường có giá trị $1 và được đúc ra tương ứng với lượng LP khoá vào.\n\n## Quỹ chỉ số\n\nỞ mô hình hàm tích hằng tổng quát, số lượng token có thể nhiều hơn 2. Khi đó LP được xem như một token đại diện cho “rổ” đầu tư. Thay vì mua một token duy nhất, người dùng có thể tham khảo mua một nhóm các token mạnh. Bạn không nhất thiết phải mua từng token một, mà chỉ cần mua LP cho hồ đại diện rổ token bạn muốn.\n\n# Lời kết\n\nQua bài viết, hi vọng bạn đọc đã có một cái nhìn tổng quát về AMM cũng như hệ sinh thái xung quanh một giao thức. Để xây dựng một giao thức thành công, các nhà sáng lập không chỉ cần xây dựng một hệ thống tốt, mà còn phải xây dựng một hệ thống có thể kết nối với các sinh thái xung quanh nó để tối đa hoá tài nguyên, cũng như mở rộng quy mô.",
    "title": "Những ví dụ kinh điển về DeFi"
  }
}